/**
 * This Api class lets you define an API endpoint and methods to request
 * data and process it.
 *
 * See the [Backend API Integration](https://docs.infinite.red/ignite-cli/boilerplate/app/services/#backend-api-integration)
 * documentation for more details.
 */
import {AccomodationItemSnapshotIn} from '@/models/AccomodationItem'
import {DestinationSnapshotIn} from '@/models/Destination'
import {PresetTodoContentSnapshotIn, TodoSnapshotIn} from '@/models/Todo'
import {TripStore, TripStoreSnapshot} from '@/models/TripStore'
import {ApiResponse, ApisauceInstance, create} from 'apisauce'
import {
  type ApiConfig,
  type ApiPresetResponse,
  PresetDTO,
  TodoDTO,
  type TripDTO,
  WithStatus,
  mapToTodo,
  mapToTodoDTO,
  mapToTrip,
  mapToTripDTO,
} from './api.types'
import {GeneralApiProblem, getGeneralApiProblem} from './apiProblem'

export interface CreateTodoRequest {
  category?: string
  presetId?: number
}

type ApiResult<T> = {kind: 'ok'; data: T} | GeneralApiProblem

/**
 * Configuring the apisauce instance.
 */
export const DEFAULT_API_CONFIG: ApiConfig = {
  url: process.env.EXPO_PUBLIC_API_URL,
  timeout: 10000,
}
/**
 * Manages all requests to the API. You can use this class to build out
 * various requests that you need to call from your backend API.
 */
export class Api {
  apisauce: ApisauceInstance
  config: ApiConfig

  /**
   * Set up our API instance. Keep this lightweight!
   */
  constructor(config: ApiConfig = DEFAULT_API_CONFIG) {
    this.config = config
    this.apisauce = create({
      baseURL: this.config.url,
      timeout: this.config.timeout,
      headers: {
        Accept: 'application/json',
      },
    })
  }

  handleResponse<T>(response: ApiResponse<T>): ApiResult<T> {
    if (!response.ok) {
      const problem = getGeneralApiProblem(response)
      if (problem) return problem
    }

    try {
      if (!response.data) {
        throw Error
      }
      return {
        kind: 'ok',
        data: response.data,
      }
    } catch (e) {
      if (__DEV__ && e instanceof Error) {
        console.error(`Bad data: ${e.message}\n${response.data}`, e.stack)
      }
      return {kind: 'bad-data'}
    }
  }

  /* Trip & Trip.todolist CRUD APIS */

  /**
   * Gets a Trip data with given id.
   * @returns {kind} - Response Status.
   * @returns {...Trip} - Trip.
   */
  async getTrip(id: string): Promise<ApiResult<TripStoreSnapshot>> {
    const response: ApiResponse<TripDTO> = await this.apisauce.get(`trip/${id}`)

    if (!response.ok) {
      const problem = getGeneralApiProblem(response)
      if (problem) return problem
    }

    try {
      const rawData = response.data
      if (!rawData) {
        throw Error
      }
      return {
        kind: 'ok',
        data: mapToTrip(rawData),
      }
    } catch (e) {
      if (__DEV__ && e instanceof Error) {
        console.error(`Bad data: ${e.message}\n${response.data}`, e.stack)
      }
      return {kind: 'bad-data'}
    }
  }
  /**
   * Create a new Trip and get id generated by B/E.
   * @returns {kind} - Response Status.
   * @returns {id} - Trip Id.
   */
  async createTrip(): Promise<
    ({kind: 'ok'} & Pick<TripStoreSnapshot, 'id'>) | GeneralApiProblem
  > {
    const response: ApiResponse<TripDTO> = await this.apisauce.post(`trip`)
    /* @TODO
        Block this and unblock following line when connecting to the constructed backend.
        defaultTrip is only used for mocking the backend with json-server
     */

    // await this.apisauce.post(`trip`, {})

    if (!response.ok) {
      const problem = getGeneralApiProblem(response)
      if (problem) return problem
    }

    try {
      if (!response.data) {
        throw Error
      }
      return {
        kind: 'ok',
        id: response.data.id.toString(),
      }
    } catch (e) {
      if (__DEV__ && e instanceof Error) {
        console.error(`Bad data: ${e.message}\n${response.data}`, e.stack)
      }
      return {kind: 'bad-data'}
    }
  }

  /**
   * Update todolist of the trip.
   * @returns {kind} - Response Status.
   * @returns {...Trip} - Updated Trip.
   */
  async patchTrip(
    trip: TripStore,
  ): Promise<{kind: 'ok'; data: TripStoreSnapshot} | GeneralApiProblem> {
    const response: ApiResponse<TripDTO> = await this.apisauce.patch(
      `/trip/${trip.id}`,
      mapToTripDTO(trip),
    )
    // await this.apisauce.post(`trip`, {})

    const tripDTO = this.handleResponse<TripDTO>(response)
    return tripDTO.kind === 'ok'
      ? {
          kind: 'ok',
          data: mapToTrip(tripDTO.data),
        }
      : tripDTO
  }

  /**
   * Update todolist of the trip.
   * @returns {kind} - Response Status.
   * @returns {...Trip} - Updated Trip.
   */
  //   async patchTodolist(
  //     trip: TripStore,
  //   ): Promise<({kind: 'ok'} & TripStoreSnapshot) | GeneralApiProblem> {
  //     console.log('patchTodolist')
  //     // make the api call
  //     const response: ApiResponse<TripDTO> = await this.apisauce.patch(
  //       `trip/${trip.id}/todolist`,
  //       {todolist: mapToTripDTO(trip).todolist},
  //     )

  //     if (!response.ok) {
  //       const problem = getGeneralApiProblem(response)
  //       if (problem) return problem
  //     }

  //     try {
  //       const rawData = response.data
  //       if (!rawData) {
  //         throw Error
  //       }
  //       return {
  //         kind: 'ok',
  //         ...mapToTrip(rawData),
  //       }
  //     } catch (e) {
  //       if (__DEV__ && e instanceof Error) {
  //         console.error(`Bad data: ${e.message}\n${response.data}`, e.stack)
  //       }
  //       return {kind: 'bad-data'}
  //     }
  //   }

  /* Todo CRUD APIS */

  /**
   * Create todo.
   * @returns {kind} - Response Status.
   * @returns {...Trip} - Updated Trip.
   */
  async createTodo({
    tripId,
    category,
    presetId,
  }: Partial<Pick<TodoSnapshotIn, 'category'>> & {
    tripId: string
    presetId?: string
  }): Promise<ApiResult<TodoSnapshotIn>> {
    const response: ApiResponse<TodoDTO> = await this.apisauce.post(
      `/trip/${tripId}/todo`,
      {category, presetId: Number(presetId)},
    )

    const todoDTOResponse = this.handleResponse<TodoDTO>(response)
    return todoDTOResponse.kind === 'ok'
      ? {
          kind: 'ok',
          data: mapToTodo(todoDTOResponse.data),
        }
      : todoDTOResponse
  }

  /**
   * Update todo.
   * @returns {kind} - Response Status.
   * @returns {...Todo} - Updated Trip.
   */
  async patchTodo(
    tripId: string,
    todo: TodoSnapshotIn,
  ): Promise<ApiResult<TodoSnapshotIn>> {
    const response: ApiResponse<TodoDTO> = await this.apisauce.patch(
      `/trip/${tripId}/todo/${todo.id}`,
      mapToTodoDTO(todo, -1),
    )

    const todoDTOResponse = this.handleResponse<TodoDTO>(response)
    return todoDTOResponse.kind === 'ok'
      ? {
          kind: 'ok',
          data: mapToTodo(todoDTOResponse.data),
        }
      : todoDTOResponse
  }

  /**
   * Update todo.
   * @returns {kind} - Response Status.
   * @returns {...Todo} - Updated Trip.
   */
  async deleteTodo(tripId: string, todoId: string): Promise<ApiResult<void>> {
    const response: ApiResponse<void> = await this.apisauce.delete(
      `/trip/${tripId}/todo/${todoId}`,
    )

    return this.handleResponse<void>(response)
  }

  /**
   * Gets a list of recent React Native Radio episodes.
   */
  async getTodoPreset(
    id: string,
  ): Promise<ApiResult<PresetTodoContentSnapshotIn[]>> {
    const response: ApiResponse<PresetDTO[]> = await this.apisauce.get(
      `trip/${id}/preset`,
    )
    const presetResponse = this.handleResponse<PresetDTO[]>(response)
    return presetResponse.kind === 'ok'
      ? {
          ...presetResponse,
          data: presetResponse.data.map(presetDTO => ({
            ...presetDTO,
            id: presetDTO.id.toString(),
          })),
        }
      : presetResponse
  }

  /**
   * Gets a list of recent React Native Radio episodes.
   */
  async createDestination(
    id: string,
  ): Promise<ApiResult<Partial<DestinationSnapshotIn>>> {
    // make the api call
    const response: ApiResponse<Partial<DestinationSnapshotIn>> =
      await this.apisauce.get(`trip/${id}/destination`)

    return this.handleResponse<Partial<DestinationSnapshotIn>>(response)
  }

  /**
   * Update todo.
   * @returns {kind} - Response Status.
   * @returns {...Todo} - Updated Trip.
   */
  async deleteDestination(
    tripId: string,
    destinationId: string,
  ): Promise<ApiResult<void>> {
    const response: ApiResponse<void> = await this.apisauce.delete(
      `/trip/${tripId}/destination/${destinationId}`,
    )

    return this.handleResponse<void>(response)
  }

  /**
   * Gets a list of recent React Native Radio episodes.
   */
  //   async getAccomodationItem(): Promise<ApiResult<AccomodationItemSnapshotIn[]>> {
  //     const response: ApiResponse<AccomodationItemSnapshotIn[]> =
  //       await this.apisauce.get(`trip/1/accomodation`)

  //     const accomodationDTO =
  //       this.handleResponse<AccomodationItemSnapshotIn[]>(response)
  //     return accomodationDTO
  //   }

  /**
   * Gets a list of recent React Native Radio episodes.
   */
  async createAccomodation(
    id: string,
  ): Promise<ApiResult<Partial<AccomodationItemSnapshotIn>>> {
    // make the api call
    const response: ApiResponse<Partial<AccomodationItemSnapshotIn>> =
      await this.apisauce.get(`trip/${id}/accomodation`)

    return this.handleResponse<Partial<AccomodationItemSnapshotIn>>(response)
  }

  /**
   * Update todo.
   * @returns {kind} - Response Status.
   * @returns {...Todo} - Updated Trip.
   */
  async patchAccomodation(
    tripId: string,
    accomodation: AccomodationItemSnapshotIn,
  ): Promise<ApiResult<Partial<AccomodationItemSnapshotIn>>> {
    const response: ApiResponse<Partial<AccomodationItemSnapshotIn>> =
      await this.apisauce.patch(
        `/trip/${tripId}/accomodation/${accomodation.id}`,
        accomodation,
      )

    const accomodationDTO =
      this.handleResponse<Partial<AccomodationItemSnapshotIn>>(response)
    return accomodationDTO
  }
  /**
   * Update todo.
   * @returns {kind} - Response Status.
   * @returns {...Todo} - Updated Trip.
   */
  async deleteAccomodation(
    tripId: string,
    accomodationId: string,
  ): Promise<ApiResult<void>> {
    const response: ApiResponse<void> = await this.apisauce.delete(
      `/trip/${tripId}/accomodation/${accomodationId}`,
    )

    return this.handleResponse<void>(response)
  }
}

// Singleton instance of the API for convenience
export const api = new Api()
